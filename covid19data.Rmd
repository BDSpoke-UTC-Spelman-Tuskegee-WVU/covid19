---
title: "JHU COVID-19 data"
author: "Matt Brauer"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.wide = TRUE)

require(tidyverse)
require(lubridate)
require(fs)
require(broom)
require(kableExtra)
require(gridExtra)
require(maps)
require(viridis)
library(ggthemes)
library(gganimate)
library(gifski)
require(usmap)
require(git2r)
require(httr)
#require(tsibble)
```
Latest version: `r commits(repository("."))[[1]]$message`

# Background


This page contains plots of unprocessed data from Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE). Since early January the CSSE has built and hosted a near real-time tracker of corona virus cases, with a [public visual dashboard](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6).

(Also see relevant Lancet paper here: [An interactive web-based dashboard to track COVID-19 in real time](https://doi.org/10.1016/S1473-3099(20)30120-1).)

Reported numbers of confirmed cases, deaths and recoveries are available in [their github repo](https://github.com/CSSEGISandData/COVID-19), which is the source for these plots.

Some cautions:

* The definition and number of "confirmed cases" is highly dependent on locale, availability and use of testing. It is a crude proxy and lagging indicator of the progress of the pandemic.
* These numbers are those reported by local authorities, and should be presumed to be inaccurate on that account.
* Reported numbers are absolute cumulative, not rates. They have not been scaled to population size.
* Dates are dates reported, not necessarily date of observation.

# Some (more sophisticated and useful) tracking resources

* [UW Virology COVID-19 Dashboard](http://depts.washington.edu/labmed/covid19/)
* [Kinsa US Health Weather Map](https://healthweather.us/): real-time tracking of atypical fever frequencies
* [Epidemic modeling](http://gabgoh.github.io/COVID/index.html)
* [NEJM Coronavirus papers](https://www.nejm.org/coronavirus?cid=DM88311&bid=165352681)
* [The COVID Tracking Project](https://covidtracking.com/)
* [Our World in Data](https://ourworldindata.org/coronavirus)
* [JHU news releases](https://releases.jhu.edu/)
* [SF Chronicle California case tracker](https://projects.sfchronicle.com/2020/coronavirus-map/)
* [Real-time tracking of pathogen evolution](https://nextstrain.org/)
* [91-divoc](https://91-divoc.com)
* [COVID-19 health data](https://covid19.healthdata.org/)

# Other news and information links

* [The Atlantic Covid-19 coverage](https://www.theatlantic.com/category/what-you-need-know-coronavirus/)
* [Home testing](https://www.ninetylawn.com/at-home-coronavirus-testing/)

# Updates and notes

JHU appears to update their data daily at around 4pm PDT. I usually re-run the script sometime after that. At other times I'm fiddling with changing layouts and refactoring code, and updates usually reflect that.

Currently, plots are aligned by setting the local day 0 as the date at which a given country/locality crosses 10% of the maximum cases, deaths, etc. in a comparison.

To do: automate the estimation of maximum exponential parameter for various curves. Currently this is done by manually setting a date range over which the fit is done.

I'll be happy to take requests for specific plots. Feel free to open an issue on the [project GitHub page](https://github.com/MattBrauer/covid19). Also, take, use and propagate any code or data you find there if you find it useful.

```{bash git-pull, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
# refresh data
#git pull --recurse-submodules
#git submodule update --remote --recursive
```

```{r covidtracking-data-load, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

covid_tracking <- "https://covidtracking.com/api/"
covid_dataset_names <- c("states", "states/daily", "states/info",
                    "us", "us/daily",
                    "counties", "urls", "press")

covid_datasets <- lapply(as.list(paste0(covid_tracking, covid_dataset_names, ".csv")),
       function(api_call) {
         response <- GET(api_call)
         content(response)
       })

names(covid_datasets) <- covid_dataset_names

covid_datasets$states_qc <- covid_datasets$states %>%
  select(state, lastUpdateEt, checkTimeEt, dateModified, dateChecked, grade)

covid_datasets$states <- covid_datasets$states %>%
  select(-lastUpdateEt, -checkTimeEt, -dateModified, -dateChecked, -grade)

covid_datasets$`states/daily` <- covid_datasets$`states/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d")) %>%
  select(-dateChecked)

covid_datasets$`us/daily` <- covid_datasets$`us/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d"))

```



```{r map-data-setup, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
states_map <- map_data("state")
counties_map <- map_data("county")

state_abbreviations <- c("AL", "AK", "AZ", "KS", "UT", "CO", "CT", 
                         "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "AR", 
                         "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", 
                         "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", 
                         "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", 
                         "CA", "VT", "VA", "WA", "WV", "WI", "WY", "DC")
state_names <- c("Alabama", "Alaska", "Arizona", "Kansas", 
                "Utah", "Colorado", "Connecticut", "Delaware", "Florida", 
                "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", 
                "Iowa", "Arkansas", "Kentucky", "Louisiana", "Maine", 
                "Maryland", "Massachusetts", "Michigan", "Minnesota", 
                "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", 
                "New Hampshire", "New Jersey", "New Mexico", "New York", 
                "North Carolina", "North Dakota", "Ohio", 
                "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
                "South Carolina", "South Dakota", "Tennessee", "Texas", 
                "California", "Vermont", "Virginia", "Washington", "West Virginia", 
                "Wisconsin", "Wyoming", "District of Columbia")
names(state_names) <- state_abbreviations
names(state_abbreviations) <- state_names
```

```{r csse-new-data-model-load, echo=FALSE, warning=FALSE, message=FALSE}

# daily reports data. follows different data models at different times, so a fair bit
#  of tweeking is necessary

data_dir <- "COVID-19/csse_covid_19_data/csse_covid_19_daily_reports"

data_model_start_dates <- as.Date(c("01-22-2020", "03-22-2020"), "%m-%d-%Y")

data_models <- Vectorize(function(obs_date, start_dates) {
  end_dates <- lead(c(start_dates,today() + days(1))-days(1))[1:length(start_dates)]
  intervals <- interval(start = start_dates, end = end_dates)
  which(obs_date %within% intervals)
}, "obs_date")

report_files <- dir_ls(data_dir, glob="*.csv")
report_dates <- as.Date(path_ext_remove(path_file(report_files)), "%m-%d-%Y")
report_models <- data_models(report_dates, data_model_start_dates)
report_sets <- as_tibble(list(file = report_files,
                              date = path_ext_remove(path_file(report_files)),
                              model = report_models))

data_columns <- cols(
  `Province/State` = col_character(),
  `Country/Region` = col_character(),
  Province_State = col_character(),
  Country_Region = col_character(),
  `Last Update` = col_skip(),
  Last_Update = col_skip(),
  Confirmed = col_double(),
  Deaths = col_double(),
  Recovered = col_double(),
  Latitude = col_double(),
  Longitude = col_double(),
  Lat = col_double(),
  Long_ = col_double(),
  FIPS = col_character(),
  Admin2 = col_character()
)

report_data <- do.call(rbind.data.frame, report_sets %>%
  split(.$model) %>%
  purrr::map(~ .x %>%
              select(date, file) %>%
              deframe() %>%
               map_dfr(read_csv, .id="date",
                       col_types=data_columns) %>%
               add_column(!!!c("FIPS","Admin2")[!c("FIPS","Admin2") %in% names(.)]) %>%
               rename_at(vars(matches("\\/")), function(x) gsub("\\/","_",x)) %>%
               rename_at(vars(matches("_$")), function(x) gsub("_$","",x)) %>%
               rename_at(vars(matches("itude$")), function(x) gsub("itude$","",x)) %>%
               rename_at(vars(matches("FIPS")), function(x) "FIPS") %>%
               rename_at(vars(matches("Admin2")), function(x) "Admin2") %>%
               mutate(date = as.Date(date, "%m-%d-%Y"),
                      FIPS = ifelse(FIPS=="FIPS", NA, FIPS),
                      Admin2 = ifelse(Admin2=="Admin2", NA, Admin2)) %>%
               select(date, FIPS, Admin2, Province_State, Country_Region,
                      Confirmed, Deaths, Recovered)
  ))

## recoding country name errors
countries <- report_data %>%
  rename("country" = Country_Region) %>%
  mutate("name" = country) %>%
  mutate(country = ifelse(grepl("Bahamas", country), "Bahamas", country),
         country = ifelse(grepl("China", country), "China", country),
         country = ifelse(grepl("Congo", country), "Congo", country),
         country = ifelse(grepl("Czech", country), "Czechia", country),
         country = ifelse(grepl("Gambia", country), "Gambia", country),
         country = ifelse(grepl("Guinea", country), "Guinea", country),
         country = ifelse(grepl("Hong Kong", country), "Hong Kong", country),
         country = ifelse(grepl("Iran", country), "Iran", country),
         country = ifelse(grepl("Ireland$", country), "Ireland", country),
         country = ifelse(grepl("Maca", country), "Macau", country),
         country = ifelse(grepl("Martin$", country), "Saint Martin", country),
         country = ifelse(grepl("Moldova$", country), "Moldova", country),
         country = ifelse(grepl("Palestin", country), "Palestine", country),
         country = ifelse(grepl("Russia", country), "Russia", country),
         country = ifelse(grepl("Timor", country), "Timor", country),
         country = ifelse(grepl("Viet", country), "Vietnam", country),
         country = ifelse(grepl("Taiwan", country) | grepl("Taipei", country),
                          "Taiwan", country),
         country = ifelse(country=="United Kingdom", "UK", country),
         country = ifelse(country=="Korea, South", "South Korea", country),
         country = ifelse(country=="Republic of Korea", "North Korea", country),
         country = ifelse(country=="Holy See" | grepl("Vatican", country),
                          "Vatican City", country),
         country = ifelse(country=="Jersey" | country=="Guernsey", "Channel Islands", country),
         country = ifelse(country=="Cote d'Ivoire", "Ivory Coast", country)) %>%
  select(name, country) %>%
  distinct() %>%
  filter(!is.na(country)) %>%
  arrange(country) %>%
  deframe()

## recoding state name errors
states <- report_data %>%
  rename("country" = Country_Region, "state" = Province_State) %>%
  mutate("name" = state) %>%
  mutate(state = ifelse(country=="US" & grepl("Virgin Islands", state),
                        "Virgin Islands", state),
         state = ifelse(country=="US" & grepl("D.C.", state),
                        "District of Columbia", state)         ) %>%
  select(name, state) %>%
  distinct() %>%
  filter(!is.na(state)) %>%
  arrange(state) %>%
  deframe()

complete <- report_data %>%
  rename("country"=Country_Region,
         "state"=Province_State,
         "county"=Admin2,
         "cases"=Confirmed,
         "deaths"=Deaths,
         "recovered"=Recovered) %>%
  mutate(country = recode(country, !!!countries)) %>%
  mutate(state = recode(state, !!!states))

```


```{r load-new-data-model, echo=FALSE, warning=FALSE, message=FALSE}

# build data structures for specific uses


# US states
# limit to US and remove locations (mostly through early March) that are specific within states
#   (e.g., "Berkeley, CA")
by_state <- complete %>%
  filter(country=="US", !grepl(",", state)) %>%
  group_by(state, date) %>%
  summarize(cases=sum(cases), recovered=sum(recovered), deaths=sum(deaths))

# totals by country
by_country <- complete %>%
  group_by(country, date) %>%
  summarize(cases=sum(cases), recovered=sum(recovered), deaths=sum(deaths))

# total by country, except US where total by state
# (for comparing US states to countries ex-US)
by_country_state <- complete %>%
  ungroup() %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)],
         region=str_trim(region),
         state=if_else(is.na(st), state, st)) %>%
  select(-st) %>%
  mutate(country = if_else(country=="US", state, country)) %>%
  group_by(country, date) %>%
  summarize(cases=sum(cases), recovered=sum(recovered), deaths=sum(deaths)) %>%
  filter(country != "US") %>%
  bind_rows(by_country) %>%
  distinct()

us_states <- by_state %>%
  ungroup() %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)], region=str_trim(region)) %>%
  mutate(state=if_else(is.na(st), state, st)) %>%
  select(-st)

us_states_current <- us_states %>%
    group_by(state, date) %>%
    summarize_if(is.numeric, sum) %>%
    arrange(state, date) %>%
    slice(n())

us_counties_current <- complete %>%
  filter(country=="US", !is.na(county)) %>%
  group_by(state, county) %>%
  top_n(1, date)

latest_date <- complete %>%
  filter(cases > 0 | recovered == 0 | deaths == 0) %>%
  select(date) %>%
  top_n(1, date) %>%
  distinct() %>%
  dplyr::pull(date)

latest_date <- as.Date(latest_date)
```


# Progression of cases compared between countries

```{r plot-all-countries, fig.wide = TRUE, fig.cap = "Progression of cases between countries. Day 0 for each country is the first day for which there is data. In some cases (e.g., China, Japan) the pandemic was well underway before data were recorded by JHU.", echo=FALSE, warning=FALSE, message=FALSE}

by_country %>%
  filter(cases >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases, group=country)) +
    geom_line(aes(color=country)) +
    geom_text(data = subset(., day == maxday & maxday > 10), aes(label = country,
                                                     colour = country,
                                                     x = day,
                                                     y = cases), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme(legend.position = "none") +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }
```

```{r country-case-facetplot, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
# 

# facetplot of countries
by_country %>%
  filter(cases >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases)) +
    geom_line() +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme(legend.position = "none") +
    facet_wrap( ~ country, ncol = 3) +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }


```

# Comparison of US to selected other countries

```{r country-plot-functions, echo=FALSE, warning=FALSE, message=FALSE}
lag_days <- function(dataset, countries) {
 first_deciles <- dataset %>%
  ungroup() %>%
  filter(country %in% countries) %>%
  summarize(cases = max(cases, na.rm=TRUE) / 10,
            deaths = max(deaths, na.rm=TRUE) / 10,
            recovered = max(recovered, na.rm=TRUE) / 10)
 
  dataset %>%
    filter(country %in% countries) %>%
    group_by(country) %>%
    summarize(cases = max(date[cases < (first_deciles %>% dplyr::pull(cases))], na.rm=TRUE),
              deaths = max(date[deaths < (first_deciles %>% dplyr::pull(deaths))], na.rm=TRUE),
              recovered = max(date[recovered < (first_deciles %>% dplyr::pull(recovered))], na.rm=TRUE))

}

country_timeplot <- function(countries, variable, topn = 10) {
  lag_day <- lag_days(by_country, countries) %>%
    select(country, (!!variable)) %>%
    deframe()
  by_country %>%
    filter(country %in% countries) %>%
    mutate("day" = date - min(date),
           "lag_date" = date - lag_day[country]) %>%
    ungroup() %>%
    mutate("lag_date" = lag_date - min(lag_date)) %>%
    group_by(country) %>%
  { ggplot(.) +
    geom_line(aes(x=lag_date, y=!!variable, color=country)) +
    geom_point(aes(x=lag_date, y=!!variable, color=country)) +
    geom_text(data = . %>%
                filter(lag_date == max(lag_date)) %>%
                ungroup() %>%
                top_n(topn, (!! variable)),
              aes(label = country, color = country, x = lag_date, y = (!! variable)),
              hjust = "right",
              vjust = "bottom") +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("Day of pandemic") +
    ylab(quo_name(variable)) +
    ggtitle(paste0(quo_name(variable), " by country as of ", latest_date))
  }
}
```


```{r us-italy-china-spain-plot, fig.wide = TRUE, fig.cap = "Pandemic trajectories of several countries. Day of pandemic is an adjustment to allow for different local pandemic start dates." , echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("China", "Italy", "Spain", "US")
p1 <- country_timeplot(countries, quo(cases))
p2 <- country_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)
```

```{r us-italy-plot, fig.wide = TRUE, fig.cap = "Comparing US to Italy. Day of pandemic is an adjustment to allow for different local pandemic start dates.", echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("Italy", "US")
p1 <- country_timeplot(countries, quo(cases))
p2 <- country_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)

```

# Confirmed cases and deaths by US state

Cumulative number of confirmed cases aggregated across all regions within state.

```{r us-specific-plot-functions, echo=FALSE, warning=FALSE, message=FALSE}
state_map <- function(variable) {
  log_breaks <- 2 * 5**seq(0,8)
  states_map %>%
    left_join(
      us_states_current %>%
        mutate(fips = state_abbreviations[state],
               region = tolower(state)) %>%
        filter(!is.na(region)) %>%
        select(region, !! variable)
      ) %>%
    ggplot(aes(long, lat, group = group)) +
    geom_polygon(aes(fill = (!! variable)), color = "white") +
    scale_fill_viridis_c(option = "C",
                         name = quo_name(variable),
                         trans = "log",
                         breaks = log_breaks, labels = log_breaks) +
    coord_fixed(1.3) +
    theme_void() +
    ggtitle(paste(quo_name(variable), "as of", latest_date))
}

states_current_barplot <- function(variable) {
  us_states_current %>%
    arrange(desc(!!variable)) %>%
    ungroup() %>%
    top_n(10, !!variable) %>%
    ggplot(aes(x=reorder(state, !!variable), y=!!variable)) +
    geom_bar(stat="identity", fill="steelblue") +
    theme_minimal() +
    coord_flip() +
    xlab("state") +
    ylab("cumulative count") +
    ggtitle(paste(quo_name(variable), " as of", latest_date))
}
```


```{r state-map-plot, fig.wide = TRUE, fig.cap = "Cases and deaths by state.", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- state_map(quo(cases))
p2 <- state_map(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

```


```{r states-barplot, fig.wide = TRUE, fig.cap = "Cases and deaths by state. Ten most affected states shown.", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- states_current_barplot(quo(cases))
p2 <- states_current_barplot(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

```


```{r state-specific-plot-functions, echo=FALSE, warning=FALSE, message=FALSE}

county_map <- function(state_to_map, variable) {
  log_breaks <- 2 * 5**seq(0,8)
  counties_map %>%
    filter(region==tolower(state_to_map)) %>%
    dplyr::select(-region) %>%
    left_join(
      us_counties_current %>%
        filter(state==state_to_map) %>%
        dplyr::select(-state) %>%
        mutate(subregion = tolower(county)) %>%
        filter(!is.na(subregion)) %>%
        select(subregion, !! variable)
      ) %>%
    select(-subregion, -state) %>%
    ggplot(aes(long, lat, group = group)) +
    geom_polygon(aes(fill = (!! variable)), color = NA) +
    scale_fill_viridis_c(option = "C",
                         name = quo_name(variable),
                         trans = "log",
                         breaks = log_breaks, labels = log_breaks) +
    coord_fixed(1.3) +
    theme_void() +
    ggtitle(paste(state_to_map, quo_name(variable), "as of", latest_date))
}

county_barplot <- function(state_plot, variable) {
  us_counties_current %>%
    filter(state==state_plot) %>%
    arrange(desc(!!variable)) %>%
    ungroup() %>%
    top_n(10, !!variable) %>%
    ggplot(aes(x=reorder(county, !!variable), y=!!variable)) +
    geom_bar(stat="identity", fill="steelblue") +
    theme_minimal() +
    coord_flip() +
    xlab("county") +
    ylab(quo_name(variable)) +
    ggtitle(paste(state_plot, quo_name(variable), "by county, as of", latest_date))
}

county_timeplot <- function(plot_country, plot_state, variable, topn=3) {
  complete %>%
    filter(country==plot_country, state==plot_state, !is.na(county)) %>%
    group_by(county) %>%
  { ggplot(.) +
    geom_line(aes(x=date, y=(!!variable), color=county)) +
    geom_text(data = . %>%
                filter(date == max(date)) %>%
                ungroup() %>%
                top_n(topn, (!! variable)),
              aes(label = county, color = county, x = date, y = (!! variable)),
              hjust = "right",
              vjust = "bottom") +
      theme_minimal() +
      theme(legend.position = "none") +
      ggtitle(paste0(plot_state, " ", quo_name(variable), " by county"))
    }
}

```

# Confirmed cases and deaths by California county

Cumulative number of confirmed cases aggregated across all regions within state.

```{r ca-county-plot, fig.wide = TRUE, fig.cap = "Cases and deaths within California.", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- county_map("California", quo(cases))
p2 <- county_map("California", quo(deaths))
grid.arrange(p1, p2, nrow = 1)
p3 <- county_barplot("California", quo(cases))
p4 <- county_barplot("California", quo(deaths))
grid.arrange(p3, p4, nrow = 1)
p5 <- county_timeplot("US", "California", quo(cases))
p6 <- county_timeplot("US", "California", quo(deaths))
grid.arrange(p5, p6, nrow = 1)
```


# Comparison of selected US states and countries

```{r country-state-plot, echo=FALSE, warning=FALSE, message=FALSE}
countries <- c("Italy", "California", "New York", "Washington")

country_state_plot <- function(countries, variable) {
  lag_day <- lag_days(by_country_state, countries) %>%
    select(country, !!variable) %>%
    deframe()
  by_country_state %>%
    filter(country %in% countries) %>%
    mutate("day" = date - min(date),
           "lag_date" = date - lag_day[country]) %>%
    rename("region" = country) %>%
    ggplot(aes(x=lag_date, y=!!variable, group=region)) +
    geom_point(aes(color=region)) +
    geom_line(aes(color=region)) +
    xlab("Day of pandemic") +
    ylab(quo_name(variable)) +
    ggtitle(paste(quo_name(variable), "as of", latest_date))
}

country_state_plot(countries, quo(cases))
country_state_plot(countries, quo(deaths))
```

# Number of tests administered (from `covidtracking.com`)

```{r state-testing-rates, echo=FALSE, warning=FALSE, message=FALSE}
states <- c("California", "New York", "Washington")

covid_datasets$`states/daily` %>%
  filter(state %in% state_abbreviations[states]) %>%
  ggplot(aes(x=date, y=total, color=state)) +
  geom_line() +
  geom_bar(aes(y=positive, fill=state), stat = "identity", position = 'dodge') +
  xlab("Date") +
  ylab("Test counts") +
  ggtitle("Number of tests administered and number positive")

```

```{r covidtracking-maps, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
states_map %>%
  left_join(
    covid_datasets$`states/daily` %>%
      group_by(state)
    mutate(state = state_names[state],
           region = tolower(state)) %>%
      filter(!is.na(region))) %>%
    select(state, date, lat, long, positive, negative, pending, hospitalized, death, total) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = cases), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Confirmed cases as of", latest_date))

states_map %>%
  left_join(
    us_states_current %>%
    mutate(fips = state_abbreviations[state],
          region = tolower(state)) %>%
    filter(!is.na(region)) %>%
    select(region, deaths)
  ) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = deaths), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Statewide deaths as of", latest_date))

```


# Estimating maximum rate of exponential growth in number of observed cases

The dates bounding the exponential phase of growth were estimated by eye, and the curve fit applied to this range.

```{r curve-fits, echo=FALSE, warning=FALSE, message=FALSE}

pick_min <- function(df) {
  df %>%
    ungroup() %>%
    select(country, min) %>%
    deframe()
}

pick_max <- function(df) {
  df %>%
    ungroup() %>%
    select(country, max) %>%
    deframe()
}

bounds <- as_tibble(list(country=c("China","New York","Italy","Spain",
                         "California","Washington", "US"),
               cases_min=as.Date(c("2020-01-22", "2020-03-08", rep("2020-03-01", 5))),
               cases_max=as.Date(c("2020-02-07", "2020-06-01",
                                    "2020-03-22", rep("2020-06-01", 4))),
               deaths_min=as.Date(c("2020-01-22", "2020-03-13", rep("2020-03-01", 5))),
               deaths_max=as.Date(c("2020-02-07", "2020-03-24", rep("2020-06-01", 5))))) %>%
  pivot_longer(-country, names_to = "bound", values_to = "date") %>%
  separate(bound, into = c("obs", "minmax"), sep = "_") %>%
  group_by(obs) %>%
  nest() %>%
  mutate(bounds = purrr::map(data, ~ pivot_wider(., names_from=minmax, values_from=date)),
         min_date = purrr::map(bounds, ~ pick_min(.)),
         max_date = purrr::map(bounds, ~ pick_max(.))) %>%
  select(obs, min_date, max_date)

exp_phase_fit <- function(dataset, bounds, variable) {
  bounds <- bounds %>%
    filter(obs==quo_name(variable)) %>%
    pivot_wider(names_from = minmax, values_from = date)
  exp_start <- bounds %>% select(country, min) %>% deframe()
  exp_end <- bounds %>% select(country, max) %>% deframe()
  dataset %>%
  filter(country %in% bounds$country,
         date <= exp_end[country] & date >= exp_start[country]) %>%
  mutate("day" = date - exp_start[country]) %>%
  group_by(country) %>%
  do(fit = lm(log(cases + 1) ~ day, data=.))
}

exp_phase_fit_cases <- exp_phase_fit(by_country_state, bounds_cases, quo(cases))
exp_phase_fit_deaths <- exp_phase_fit(by_country_state, bounds_deaths, quo(deaths))

```

```{r curve-fit-plot-functions, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

countries <- bounds_cases$country

country_log_timeplot <- function(dataset, countries, variable, topn = 10) {
  lag_day <- lag_days(dataset, countries) %>%
    select(country, (!!variable)) %>%
    deframe()
  dataset %>%
    filter(country %in% countries) %>%
    mutate("day" = date - min(date),
           "lag_date" = date - lag_day[country]) %>%
    ungroup() %>%
    mutate("lag_date" = lag_date - min(lag_date)) %>%
    group_by(country) %>%
  { ggplot(.) +
    geom_line(aes(x=lag_date, y=!!variable, color=country)) +
    geom_point(aes(x=lag_date, y=!!variable, color=country)) +
    geom_text(data = . %>%
                filter(lag_date == max(lag_date)) %>%
                ungroup() %>%
                top_n(topn, (!! variable)),
              aes(label = country, color = country, x = lag_date, y = (!! variable)),
              hjust = "right",
              vjust = "bottom") +
    scale_y_log10() +
    theme_minimal() +
    theme(legend.position = "none") +
    xlab("Day of pandemic") +
    ylab(quo_name(variable)) +
    ggtitle(paste0(quo_name(variable), " by country as of ", latest_date))
  }
}

p1 <- country_log_timeplot(by_country_state, countries, quo(deaths), topn=10)


lag_day <- lag_days(by_country_state, countries) %>% select(country, cases) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - lag_day[country], "log_confirmed" = log(cases + 1)) %>%
  ggplot(aes(x=date, y=log_confirmed), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("Log(confirmed cases)") +
  ggtitle(paste("Confirmed cases as of", latest_date))

exp_phase_fit_cases %>%
  augment(fit) %>%
  rename("log_confirmed" = `log.cases...1.`) %>%
  ggplot(aes(x=day, y=log_confirmed), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log10(confirmed cases)") +
  ggtitle(paste("Exponential phase of growth in confirmed cases as of", latest_date))

lag_day <- lag_days(by_country_state, countries) %>% select(country, deaths) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - lag_day[country], "log_deaths" = log(deaths + 1)) %>%
  ggplot(aes(x=date, y=log_deaths), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("log(deaths)") +
  ggtitle(paste("Deaths as of", latest_date))

exp_phase_fit_deaths %>%
  augment(fit) %>%
  rename("log_deaths" = `log.deaths...1.`) %>%
  ggplot(aes(x=day, y=log_deaths), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log(deaths)") +
  ggtitle(paste("Exponential phase of growth in deaths as of", latest_date))

```

```{r exp-fit-tables, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}

exp_phase_tabular <- exp_phase_fit %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in confirmed cases")

exp_phase_deaths_tabular <- exp_phase_fit_deaths %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_deaths_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_deaths_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in deaths")
```

