---
title: "JHU COVID-19 data"
author: "Matt Brauer"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(lubridate)
require(fs)
require(broom)
require(kableExtra)
require(maps)
require(viridis)
library(ggthemes)
library(gganimate)
library(gifski)
require(usmap)
require(git2r)
require(httr)
```
Latest version: `r commits(repository("."))[[1]]$message`

# Background


This page contains plots of unprocessed data from Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE). Since early January the CSSE has built and hosted a near real-time tracker of corona virus cases, with a [public visual dashboard](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6).

(Also see relevant Lancet paper here: [An interactive web-based dashboard to track COVID-19 in real time](https://doi.org/10.1016/S1473-3099(20)30120-1).)

Reported numbers of confirmed cases, deaths and recoveries are available in [their github repo](https://github.com/CSSEGISandData/COVID-19), which is the source for these plots.

Some cautions:

* The definition and number of "confirmed cases" is highly dependent on locale, availability and use of testing. It is a crude proxy and lagging indicator of the progress of the pandemic.
* These numbers are those reported by local authorities, and should be presumed to be inaccurate on that account.
* Reported numbers are absolute cumulative, not rates. They have not been scaled to population size.
* Dates are dates reported, not necessarily date of observation.

# Other (more sophisticated and useful) tracking resources

* [UW Virology COVID-19 Dashboard](http://depts.washington.edu/labmed/covid19/)
* [Kinsa US Health Weather Map](https://healthweather.us/): real-time tracking of atypical fever frequencies
* [Epidemic modeling](http://gabgoh.github.io/COVID/index.html)
* [NEJM Coronavirus papers](https://www.nejm.org/coronavirus?cid=DM88311&bid=165352681)
* [The COVID Tracking Project](https://covidtracking.com/)
* [Our World in Data](https://ourworldindata.org/coronavirus)
* [JHU news releases](https://releases.jhu.edu/)
* [SF Chronicle California case tracker](https://projects.sfchronicle.com/2020/coronavirus-map/)
* [Reat-time tracking of pathogen evolution](https://nextstrain.org/)

# Other news and information links

* [The Atlantic Covid-19 coverage](https://www.theatlantic.com/category/what-you-need-know-coronavirus/)
* [Home testing](https://www.ninetylawn.com/at-home-coronavirus-testing/)

# Updates

Currently, plots are aligned by setting the local day 0 as the date at which a given country/locality crosses 10% of the maximum cases, deaths, etc. in a comparison.

To do: automate the estimation of maximum exponential parameter for various curves. Currently this is done by manually setting a date range over which the fit is done.

```{bash git-pull, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
# refresh data
#git pull --recurse-submodules
#git submodule update --remote --recursive
```

```{r covidtracking-data-load, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

covid_tracking <- "https://covidtracking.com/api/"
covid_dataset_names <- c("states", "states/daily", "states/info",
                    "us", "us/daily",
                    "counties", "urls", "press")

covid_datasets <- lapply(as.list(paste0(covid_tracking, covid_dataset_names, ".csv")),
       function(api_call) {
         response <- GET(api_call)
         content(response)
       })

names(covid_datasets) <- covid_dataset_names

covid_datasets$states_qc <- covid_datasets$states %>%
  select(state, lastUpdateEt, checkTimeEt, dateModified, dateChecked, grade)

covid_datasets$states <- covid_datasets$states %>%
  select(-lastUpdateEt, -checkTimeEt, -dateModified, -dateChecked, -grade)

covid_datasets$`states/daily` <- covid_datasets$`states/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d")) %>%
  select(-dateChecked)

covid_datasets$`us/daily` <- covid_datasets$`us/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d"))

```



```{r state-data-setup, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
states_map <- map_data("state")

state_abbreviations <- c("AL", "AK", "AZ", "KS", "UT", "CO", "CT", 
                         "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "AR", 
                         "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", 
                         "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", 
                         "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", 
                         "CA", "VT", "VA", "WA", "WV", "WI", "WY", "DC")
state_names <- c("Alabama", "Alaska", "Arizona", "Kansas", 
                "Utah", "Colorado", "Connecticut", "Delaware", "Florida", 
                "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", 
                "Iowa", "Arkansas", "Kentucky", "Louisiana", "Maine", 
                "Maryland", "Massachusetts", "Michigan", "Minnesota", 
                "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", 
                "New Hampshire", "New Jersey", "New Mexico", "New York", 
                "North Carolina", "North Dakota", "Ohio", 
                "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
                "South Carolina", "South Dakota", "Tennessee", "Texas", 
                "California", "Vermont", "Virginia", "Washington", "West Virginia", 
                "Wisconsin", "Wyoming", "District of Columbia")
names(state_names) <- state_abbreviations
names(state_abbreviations) <- state_names

lag_days <- c(0, 31, 36, 40, 53, 44, 53)
names(lag_days) <- c("China","Italy","Spain","US", "California", "New York", "Washington")

cutoff_date <- today()
```


```{r csse-time-series-data, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
# time series files using the old data model, good through March 22 and deprecated thereafter
# reloading and keeping this as a comparison/sanity check on the daily data

data_dir <- "COVID-19/csse_covid_19_data/csse_covid_19_time_series"

# load and tidy the data
confirmed <- read_csv(paste0(data_dir, "/time_series_19-covid-Confirmed.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("confirmed" = cases)


deaths <- read_csv(paste0(data_dir, "/time_series_19-covid-Deaths.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("deaths" = cases)


recovered <- read_csv(paste0(data_dir, "/time_series_19-covid-Recovered.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("recovered" = cases)

# join the variables, removing empty rows
complete_ts <- confirmed %>%
  left_join(recovered) %>%
  left_join(deaths) %>%
  filter(!is.na(confirmed), !is.na(recovered), !is.na(deaths),
         date < "2020-03-23")

```


```{r csse-new-data-model-load, echo=FALSE, warning=FALSE, message=FALSE}

# daily reports data. follows different data models at different times

data_dir <- "COVID-19/csse_covid_19_data/csse_covid_19_daily_reports"

data_model_start_dates <- as.Date(c("01-22-2020", "03-22-2020"), "%m-%d-%Y")

data_models <- Vectorize(function(obs_date, start_dates) {
  end_dates <- lead(c(start_dates,today() + days(1))-days(1))[1:length(start_dates)]
  intervals <- interval(start = start_dates, end = end_dates)
  which(obs_date %within% intervals)
}, "obs_date")

report_files <- dir_ls(data_dir, glob="*.csv")
report_dates <- as.Date(path_ext_remove(path_file(report_files)), "%m-%d-%Y")
report_models <- data_models(report_dates, data_model_start_dates)
report_sets <- as_tibble(list(file = report_files,
                              date = path_ext_remove(path_file(report_files)),
                              model = report_models))

data_columns <- cols(
  `Province/State` = col_character(),
  `Country/Region` = col_character(),
  Province_State = col_character(),
  Country_Region = col_character(),
  `Last Update` = col_skip(),
  Last_Update = col_skip(),
  Confirmed = col_double(),
  Deaths = col_double(),
  Recovered = col_double(),
  Latitude = col_double(),
  Longitude = col_double(),
  Lat = col_double(),
  Long_ = col_double(),
  FIPS = col_character(),
  Admin2 = col_character()
)

report_data <- do.call(rbind.data.frame, report_sets %>%
  split(.$model) %>%
  purrr::map(~ .x %>%
              select(date, file) %>%
              deframe() %>%
               map_dfr(read_csv, .id="date",
                       col_types=data_columns) %>%
               add_column(!!!c("FIPS","Admin2")[!c("FIPS","Admin2") %in% names(.)]) %>%
               rename_at(vars(matches("\\/")), function(x) gsub("\\/","_",x)) %>%
               rename_at(vars(matches("_$")), function(x) gsub("_$","",x)) %>%
               rename_at(vars(matches("itude$")), function(x) gsub("itude$","",x)) %>%
               rename_at(vars(matches("FIPS")), function(x) "FIPS") %>%
               rename_at(vars(matches("Admin2")), function(x) "Admin2") %>%
               mutate(date = as.Date(date, "%m-%d-%Y"),
                      FIPS = ifelse(FIPS=="FIPS", NA, FIPS),
                      Admin2 = ifelse(Admin2=="Admin2", NA, Admin2)) %>%
               select(date, FIPS, Admin2, Province_State, Country_Region,
                      Confirmed, Deaths, Recovered)
  ))

## recoding country name errors
countries <- report_data %>%
  rename("country" = Country_Region) %>%
  mutate("name" = country) %>%
  mutate(country = ifelse(grepl("Bahamas", country), "Bahamas", country),
         country = ifelse(grepl("China", country), "China", country),
         country = ifelse(grepl("Congo", country), "Congo", country),
         country = ifelse(grepl("Czech", country), "Czechia", country),
         country = ifelse(grepl("Gambia", country), "Gambia", country),
         country = ifelse(grepl("Guinea", country), "Guinea", country),
         country = ifelse(grepl("Hong Kong", country), "Hong Kong", country),
         country = ifelse(grepl("Iran", country), "Iran", country),
         country = ifelse(grepl("Ireland$", country), "Ireland", country),
         country = ifelse(grepl("Maca", country), "Macau", country),
         country = ifelse(grepl("Martin$", country), "Saint Martin", country),
         country = ifelse(grepl("Moldova$", country), "Moldova", country),
         country = ifelse(grepl("Palestin", country), "Palestine", country),
         country = ifelse(grepl("Russia", country), "Russia", country),
         country = ifelse(grepl("Timor", country), "Timor", country),
         country = ifelse(grepl("Viet", country), "Vietnam", country),
         country = ifelse(grepl("Taiwan", country) | grepl("Taipei", country),
                          "Taiwan", country),
         country = ifelse(country=="United Kingdom", "UK", country),
         country = ifelse(country=="Korea, South", "South Korea", country),
         country = ifelse(country=="Republic of Korea", "North Korea", country),
         country = ifelse(country=="Holy See" | grepl("Vatican", country),
                          "Vatican City", country),
         country = ifelse(country=="Jersey" | country=="Guernsey", "Channel Islands", country),
         country = ifelse(country=="Cote d'Ivoire", "Ivory Coast", country)) %>%
  select(name, country) %>%
  distinct() %>%
  filter(!is.na(country)) %>%
  arrange(country) %>%
  deframe()

complete <- report_data %>%
  rename("state"=Province_State,
         "country"=Country_Region, 
         "confirmed"=Confirmed,
         "deaths"=Deaths,
         "recovered"=Recovered) %>%
  mutate(country = recode(country, !!!countries))

```


```{r load-new-data-model, echo=FALSE, warning=FALSE, message=FALSE}

# build data structures for plotting

by_region <- complete %>%
  filter(country=="US") %>%
  mutate(state = recode(state,
         "Washington, D.C."="District of Columbia",
         "Virgin Islands, U.S."="US Virgin Islands")) %>%
  group_by(state, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

by_country <- complete %>%
  group_by(country, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

by_country_state <- complete %>%
  ungroup() %>%
  mutate(state = recode(state,
         "Washington, D.C."="District of Columbia",
         "Virgin Islands, U.S."="US Virgin Islands")) %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)],
         region=str_trim(region),
         state=if_else(is.na(st), state, st)) %>%
  select(-st) %>%
  mutate(country = if_else(country=="US", state, country)) %>%
  group_by(country, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths)) %>%
  filter(country != "US") %>%
  bind_rows(by_country) %>%
  distinct()

by_region_cumulative <- by_region %>%
  group_by(state) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

us_states <- by_region %>%
  ungroup() %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)], region=str_trim(region)) %>%
  mutate(state=if_else(is.na(st), state, st)) %>%
  select(-st)

us_states_current <- us_states %>%
    group_by(state, date) %>%
    summarize_if(is.numeric, sum) %>%
    arrange(state, date) %>%
    slice(n())

latest_date <- complete %>%
  filter(confirmed > 0 | recovered == 0 | deaths == 0) %>%
  select(date) %>%
  top_n(1, date) %>%
  distinct() %>%
  dplyr::pull(date)

latest_date <- as.Date(latest_date)
```


# Reported cumulative confirmed cases for all countries

```{r all-countries, echo=FALSE, warning=FALSE, message=FALSE}

by_country %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=confirmed, group=country)) +
    geom_line(aes(color=country)) +
    geom_text(data = subset(., day == maxday & maxday > 10), aes(label = country,
                                                     colour = country,
                                                     x = day,
                                                     y = confirmed), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme(legend.position = "none") +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }


```



# Confirmed cases and deaths by US state

Cumulative number of confirmed cases aggregated across all regions within state.

```{r map-plot, echo=FALSE, warning=FALSE, message=FALSE}
states_map %>%
  left_join(
    us_states_current %>%
    mutate(fips = state_abbreviations[state],
          region = tolower(state)) %>%
    filter(!is.na(region)) %>%
    select(region, confirmed)
  ) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = confirmed), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Confirmed cases as of", latest_date))

states_map %>%
  left_join(
    us_states_current %>%
    mutate(fips = state_abbreviations[state],
          region = tolower(state)) %>%
    filter(!is.na(region)) %>%
    select(region, deaths)
  ) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = deaths), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Statewide deaths as of", latest_date))

```

# Current status of most affected states

Aggregated cumulative data for 10 states with highest number of reported cumulative cases or deaths.

```{r states-plot-confirmed, echo=FALSE, warning=FALSE, message=FALSE}
us_states_current %>%
  arrange(desc(confirmed)) %>%
  ungroup() %>%
  top_n(10, confirmed) %>%
  ggplot(aes(x=reorder(state, confirmed), y=confirmed)) +
  geom_bar(stat="identity", fill="steelblue") +
  theme_minimal() +
  coord_flip() +
  xlab("state") +
  ylab("cumulative cases") +
  ggtitle(paste("Confirmed cases as of", latest_date))

```

```{r states-plot-deaths, echo=FALSE, warning=FALSE, message=FALSE}
us_states_current %>%
  arrange(desc(deaths)) %>%
  ungroup() %>%
  top_n(10, deaths) %>%
  ggplot(aes(x=reorder(state, deaths), y=deaths)) +
  geom_bar(stat="identity", fill="steelblue") +
  theme_minimal() +
  coord_flip() +
  xlab("state") +
  ylab("deaths") +
  ggtitle(paste("Statewide deaths as of", latest_date))

```

# Comparison of US to selected other countries

"Day of pandemic" is an adjustment to allow for different local pandemic start dates 

Vs. Italy, Spain and China.

```{r us-italy-china-spain-plot, echo=FALSE, warning=FALSE, message=FALSE}
lag_days <- function(dataset, countries) {
 first_deciles <- dataset %>%
  ungroup() %>%
  filter(country %in% countries) %>%
  summarize(confirmed = max(confirmed, na.rm=TRUE) / 10,
            deaths = max(deaths, na.rm=TRUE) / 10,
            recovered = max(recovered, na.rm=TRUE) / 10)
 
  dataset %>%
    filter(country %in% countries) %>%
    group_by(country) %>%
    summarize(confirmed = max(date[confirmed < (first_deciles %>% dplyr::pull(confirmed))], na.rm=TRUE),
              deaths = max(date[deaths < (first_deciles %>% dplyr::pull(deaths))], na.rm=TRUE),
              recovered = max(date[recovered < (first_deciles %>% dplyr::pull(recovered))], na.rm=TRUE))

  }

countries <- c("China", "Italy", "Spain", "US")

lag_day <- lag_days(by_country, countries) %>% select(country, confirmed) %>% deframe()

by_country %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  ungroup() %>%
  mutate("lag_date" = lag_date - min(lag_date)) %>%
  ggplot(aes(x=lag_date, y=confirmed, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  geom_bar(aes(y=deaths, fill=country), stat="identity") +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  xlim(0, NA) +
  ggtitle(paste("Confirmed cases as of", latest_date))

lag_day <- lag_days(by_country, countries) %>% select(country, deaths) %>% deframe()

by_country %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  ungroup() %>%
  ungroup() %>%
  mutate("lag_date" = lag_date - min(lag_date)) %>%
  ggplot(aes(x=lag_date, y=deaths, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  xlab("Day of pandemic") +
  ylab("Deaths") +
  xlim(-8, NA) +
  ggtitle(paste("Deaths as of", latest_date))

```

Focus on Italy.

```{r us-italy-plot, echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("Italy", "US")
lag_day <- lag_days(by_country, countries) %>% select(country, confirmed) %>% deframe()

by_country %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  ggplot(aes(x=lag_date, y=confirmed, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  ggtitle(paste("Confirmed cases as of", latest_date))

lag_day <- lag_days(by_country, countries) %>% select(country, deaths) %>% deframe()

by_country %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  ggplot(aes(x=lag_date, y=deaths, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  xlab("Day of pandemic") +
  ylab("Deaths") +
  ggtitle(paste("Deaths as of", latest_date))

```

# Comparison of selected US states and countries



```{r country-state-plot, echo=FALSE, warning=FALSE, message=FALSE}
countries <- c("Italy", "California", "New York", "Washington")

lag_day <- lag_days(by_country_state, countries) %>% select(country, confirmed) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  rename("region" = country) %>%
  ggplot(aes(x=lag_date, y=confirmed, group=region)) +
  geom_point(aes(color=region)) +
  geom_line(aes(color=region)) +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  ggtitle(paste("Confirmed cases as of", latest_date))

lag_day <- lag_days(by_country_state, countries) %>% select(country, deaths) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_day[country]) %>%
  rename("region" = country) %>%
  ggplot(aes(x=lag_date, y=deaths, group=region)) +
  geom_point(aes(color=region)) +
  geom_line(aes(color=region)) +
  xlab("Day of pandemic") +
  ylab("Deaths") +
  ggtitle(paste("Deaths as of", latest_date))
```

# Number of tests administered (from `covidtracking.com`)

```{r state-testing-rates, echo=FALSE, warning=FALSE, message=FALSE}
states <- c("California", "New York", "Washington")

covid_datasets$`states/daily` %>%
  filter(state %in% state_abbreviations[states]) %>%
  ggplot(aes(x=date, y=total, color=state)) +
  geom_line() +
  geom_bar(aes(y=positive, fill=state), stat = "identity", position = 'dodge') +
  xlab("Date") +
  ylab("Test counts") +
  ggtitle("Number of tests administered and number positive")

```

# Estimating maximum rate of exponential growth in number of observed cases

The dates bounding the exponential phase of growth were estimated by eye, and the curve fit applied to this range.

```{r curve-fits, echo=FALSE, warning=FALSE, message=FALSE}


exp_phase_countries <- c("China","New York","Italy","Spain","California","Washington", "US")
exp_start <- as.Date(c("2020-01-22", "2020-03-08", rep("2020-03-01", 5)))
exp_end <- as.Date(c("2020-02-07", "2020-06-01", "2020-03-22", rep("2020-06-01", 5)))

exp_start_deaths <- as.Date(c("2020-01-22", "2020-03-13", rep("2020-03-01", 5)))
exp_end_deaths <- as.Date(c("2020-02-07", "2020-03-24", rep("2020-06-01", 5)))

names(exp_start) <- names(exp_start_deaths) <- exp_phase_countries
names(exp_end) <- names(exp_end_deaths) <- exp_phase_countries

exp_phase_fit <- by_country_state %>%
  filter(country %in% exp_phase_countries,
         date <= exp_end[country] & date >= exp_start[country]) %>%
  mutate("day" = date - exp_start[country]) %>%
  group_by(country) %>%
  do(fit = lm(log(confirmed + 1) ~ day, data=.))

exp_phase_fit_deaths <- by_country_state %>%
  filter(country %in% exp_phase_countries,
         date <= exp_end_deaths[country] & date >= exp_start_deaths[country]) %>%
  mutate("day" = date - exp_start_deaths[country]) %>%
  group_by(country) %>%
  do(fit = lm(log(deaths + 1) ~ day, data=.))
```

```{r curve-fit-plots, echo=FALSE, warning=FALSE, message=FALSE}

countries <- c(exp_phase_countries, "US")

lag_day <- lag_days(by_country_state, countries) %>% select(country, confirmed) %>% deframe()

by_country_state %>%
  filter(country %in% c(exp_phase_countries, "US")) %>%
  mutate("day" = date - lag_day[country], "log_confirmed" = log(confirmed + 1)) %>%
  ggplot(aes(x=date, y=log_confirmed), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("Log(confirmed cases)") +
  ggtitle(paste("Confirmed cases as of", latest_date))

exp_phase_fit %>%
  augment(fit) %>%
  rename("log_confirmed" = `log.confirmed...1.`) %>%
  ggplot(aes(x=day, y=log_confirmed), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log10(confirmed cases)") +
  ggtitle(paste("Exponential phase of growth in confirmed cases as of", latest_date))

lag_day <- lag_days(by_country_state, countries) %>% select(country, deaths) %>% deframe()

by_country_state %>%
  filter(country %in% c(exp_phase_countries, "US")) %>%
  mutate("day" = date - lag_day[country], "log_deaths" = log(deaths + 1)) %>%
  ggplot(aes(x=date, y=log_deaths), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("log(deaths)") +
  ggtitle(paste("Deaths as of", latest_date))

exp_phase_fit_deaths %>%
  augment(fit) %>%
  rename("log_deaths" = `log.deaths...1.`) %>%
  ggplot(aes(x=day, y=log_deaths), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log(deaths)") +
  ggtitle(paste("Exponential phase of growth in deaths as of", latest_date))

```

```{r exp-fit-tables, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}

exp_phase_tabular <- exp_phase_fit %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in confirmed cases")

exp_phase_deaths_tabular <- exp_phase_fit_deaths %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_deaths_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_deaths_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in deaths")
```

