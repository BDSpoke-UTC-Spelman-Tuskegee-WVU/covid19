---
title: "JHU COVID-19 data"
author: "Matt Brauer"
date: "3/16/2020"
output: html_document
---

```{bash git-pull, echo=FALSE, warning=FALSE, message=FALSE}
# refresh data
#git pull --recurse-submodules
git submodule update --remote --recursive
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(lubridate)
require(broom)
require(kableExtra)
require(maps)
require(viridis)
library(ggthemes)
library(gganimate)
library(gifski)

require(usmap)
states_map <- map_data("state")

data_dir <- "COVID-19/csse_covid_19_data/csse_covid_19_time_series"

state_abbreviations <- c("AL", "AK", "AZ", "KS", "UT", "CO", "CT", 
                         "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "AR", 
                         "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", 
                         "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", 
                         "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", 
                         "CA", "VT", "VA", "WA", "WV", "WI", "WY", "DC")
state_names <- c("Alabama", "Alaska", "Arizona", "Kansas", 
                "Utah", "Colorado", "Connecticut", "Delaware", "Florida", 
                "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", 
                "Iowa", "Arkansas", "Kentucky", "Louisiana", "Maine", 
                "Maryland", "Massachusetts", "Michigan", "Minnesota", 
                "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", 
                "New Hampshire", "New Jersey", "New Mexico", "New York", 
                "North Carolina", "North Dakota", "Ohio", 
                "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
                "South Carolina", "South Dakota", "Tennessee", "Texas", 
                "California", "Vermont", "Virginia", "Washington", "West Virginia", 
                "Wisconsin", "Wyoming", "District of Columbia")
names(state_names) <- state_abbreviations
names(state_abbreviations) <- state_names

lag_countries <- c("China","Italy","Spain","US")
lag_days <- c(0, 33, 44, 44)
names(lag_days) <- lag_countries

exp_phase_countries <- c("China","New York","Italy","Spain","California","Washington")
exp_start <- as.Date(c("2020-01-22", "2020-03-06", rep("2020-03-01", 4)))
exp_end <- as.Date(c("2020-02-07", "2020-06-01", rep("2020-06-01", 4)))
names(exp_start) <- exp_phase_countries
names(exp_end) <- exp_phase_countries

cutoff_date <- today()
```


```{r data-load, echo=FALSE, warning=FALSE, message=FALSE}
# load and tidy the data
confirmed <- read_csv(paste0(data_dir, "/time_series_19-covid-Confirmed.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("confirmed" = cases)


deaths <- read_csv(paste0(data_dir, "/time_series_19-covid-Deaths.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("deaths" = cases)


recovered <- read_csv(paste0(data_dir, "/time_series_19-covid-Recovered.csv")) %>%
  pivot_longer(cols=c(-`Province/State`, -`Country/Region`, -Lat, -Long),
               names_to="date",
               values_to="cases") %>%
  rename("country" = `Country/Region`, "state" = `Province/State`) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  rename("recovered" = cases)

# join the variables
complete <- confirmed %>%
  left_join(recovered) %>%
  left_join(deaths)

by_region <- complete %>%
  filter(country=="US") %>%
  mutate(state = recode(state,
         "Washington, D.C."="District of Columbia",
         "Virgin Islands, U.S."="US Virgin Islands")) %>%
  group_by(state, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

by_country <- complete %>%
  group_by(country, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

by_country_state <- complete %>%
  ungroup() %>%
  mutate(state = recode(state,
         "Washington, D.C."="District of Columbia",
         "Virgin Islands, U.S."="US Virgin Islands")) %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)],
         region=str_trim(region),
         state=if_else(is.na(st), state, st)) %>%
  select(-st) %>%
  mutate(country = if_else(country=="US", state, country)) %>%
  group_by(country, date) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

by_region_cumulative <- by_region %>%
  group_by(state) %>%
  summarize(confirmed=sum(confirmed), recovered=sum(recovered), deaths=sum(deaths))

us_states <- by_region %>%
  ungroup() %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)], region=str_trim(region)) %>%
  mutate(state=if_else(is.na(st), state, st)) %>%
  select(-st)

us_states_current <- us_states %>%
    group_by(state, date) %>%
    summarize_if(is.numeric, sum) %>%
    arrange(state, date) %>%
    slice(n())

latest_date <- complete %>%
  filter(confirmed > 0 | recovered == 0 | deaths == 0) %>%
  select(date) %>%
  top_n(1, date) %>%
  distinct() %>%
  pull(date)

latest_date <- as.Date(latest_date)

exp_fits <- by_country_state %>%
  group_by(country) %>%
  do(fit = lm(log10(confirmed + 1) ~ date, data=.)) %>%
  augment(fit) %>%
  rename("log_confirmed" = `log10.confirmed...1.`)

exp_phase_fit <- by_country_state %>%
  filter(country %in% exp_phase_countries,
         date <= exp_end[country] & date >= exp_start[country]) %>%
  mutate("day" = date - exp_start[country]) %>%
  group_by(country) %>%
  do(fit = lm(log10(confirmed + 1) ~ day, data=.))

exp_phase <- exp_phase_fit %>%
  augment(fit) %>%
  rename("log_confirmed" = `log10.confirmed...1.`)

```


## Reported cumulative confirmed cases for all countries

```{r all-countries, echo=FALSE, warning=FALSE, message=FALSE}

by_country %>%
  filter(confirmed >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=confirmed, group=country)) +
    geom_line(aes(color=country)) +
    geom_text(data = subset(., day == maxday & maxday > 10), aes(label = country,
                                                     colour = country,
                                                     x = day,
                                                     y = confirmed), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme(legend.position = "none") +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }


```



## Confirmed cases by US state

Cumulative number of confirmed cases aggregated across all regions within state.

```{r map-plot, echo=FALSE, warning=FALSE, message=FALSE}
states_map %>%
  left_join(
    us_states_current %>%
    mutate(fips = state_abbreviations[state],
          region = tolower(state)) %>%
    filter(!is.na(region)) %>%
    select(region, confirmed)
  ) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = confirmed), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Confirmed cases as of", latest_date))
```

## Current status of most affected states

Aggregated cumulative data for 10 states with highest number of reported cumulative cases or deaths.

```{r states-plot-confirmed, echo=FALSE, warning=FALSE, message=FALSE}
us_states_current %>%
  arrange(desc(confirmed)) %>%
  ungroup() %>%
  top_n(10, confirmed) %>%
  ggplot(aes(x=reorder(state, confirmed), y=confirmed)) +
  geom_bar(stat="identity", fill="steelblue") +
  theme_minimal() +
  coord_flip() +
  xlab("state") +
  ylab("cumulative cases") +
  ggtitle(paste("Confirmed cases as of", latest_date))

```

```{r states-plot-deaths, echo=FALSE, warning=FALSE, message=FALSE}
us_states_current %>%
  arrange(desc(deaths)) %>%
  ungroup() %>%
  top_n(10, deaths) %>%
  ggplot(aes(x=reorder(state, deaths), y=deaths)) +
  geom_bar(stat="identity", fill="steelblue") +
  theme_minimal() +
  coord_flip() +
  xlab("state") +
  ylab("deaths") +
  ggtitle(paste("Deaths as of", latest_date))

```

## Comparison of US to other selected other countries

Vs. Italy, Spain and China.

```{r us-italy-china-spain-plot, echo=FALSE, warning=FALSE, message=FALSE}
by_country %>%
  filter(country %in% lag_countries) %>%
  mutate("day" = date - min(date),
         "lag_date" = date - lag_days[country],
         "lag_days" = lag_date - min(date)) %>%
  ggplot(aes(x=lag_days, y=confirmed, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  xlim(0, NA) +
  ggtitle(paste("Confirmed cases as of", latest_date))
```

Focus on Italy.

```{r us-italy-plot, echo=FALSE, warning=FALSE, message=FALSE}
by_country %>%
  filter(country=="Italy" | country=="US") %>%
  mutate("day" = date - min(date),
         "lag_date" = if_else(country=="Italy", date, date - days(11)),
         "lag_days" = lag_date - min(date)) %>%
  ggplot(aes(x=lag_days, y=confirmed, group=country)) +
  geom_point(aes(color=country)) +
  geom_line(aes(color=country)) +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  xlim(20, NA) +
  ggtitle(paste("Confirmed cases as of", latest_date))

```

## Comparison of selected US states and countries



```{r country-state-plot, echo=FALSE, warning=FALSE, message=FALSE}
by_country_state %>%
  filter(country=="Italy" | country=="California" | country=="New York" | country=="Washington") %>%
  mutate("day" = date - min(date),
         "lag_date" = if_else(country=="Italy", date, date - days(11)),
         "lag_days" = lag_date - min(date)) %>%
  rename("region" = country) %>%
  ggplot(aes(x=lag_days, y=confirmed, group=region)) +
  geom_point(aes(color=region)) +
  geom_line(aes(color=region)) +
  xlab("Day of pandemic") +
  ylab("Confirmed cases") +
  xlim(20, NA) +
  ggtitle(paste("Confirmed cases as of", latest_date))
```

## Estimating maximum rate of exponential growth in number of observed cases

The dates bounding the exponential phase of growth were estimated by eye, and the curve fit applied to this range.

```{r curve-fits, echo=FALSE, warning=FALSE, message=FALSE}

exp_phase %>%
  ggplot(aes(x=day, y=log_confirmed), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("Confirmed cases") +
  ggtitle(paste("Exponential phase of growth in confirmed cases as of", latest_date))
```

```{r exp-fit-table, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
exp_phase_tabular <- exp_phase_fit %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in confirmed cases")
```

