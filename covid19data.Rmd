---
title: "COVID-19 epidemiology data"
author: "Matt Brauer"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.wide = TRUE)

source("covid19data.R")
```
Latest version: `r commits(repository("."))[[1]]$message`

# Background


This page contains plots of unprocessed data from Johns Hopkins University Center for Systems Science and Engineering (JHU CSSE). Since early January the CSSE has built and hosted a near real-time tracker of corona virus cases, with a [public visual dashboard](https://coronavirus.jhu.edu/map.html).

(Also see relevant Lancet paper here: [An interactive web-based dashboard to track COVID-19 in real time](https://doi.org/10.1016/S1473-3099(20)30120-1).)

Reported numbers of confirmed cases, deaths and recoveries are available in [their github repo](https://github.com/CSSEGISandData/COVID-19), which is the source for these plots.

Some cautions:

* The definition and number of "confirmed cases" is highly dependent on locale, availability and use of testing. It is a crude proxy and lagging indicator of the progress of the pandemic.
* These numbers are those reported by local authorities, and should be presumed to be inaccurate on that account.
* Reported numbers are absolute cumulative, not rates. They have not been scaled to population size.
* Dates are dates reported, not necessarily date of observation.

```{bash git-pull, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
## refresh data from JHU, NY Times and OWID github repos
git submodule update --remote --recursive
```


```{r data-sources, echo=FALSE, warning=FALSE, message=FALSE}
csse_data_dir <- "COVID-19/csse_covid_19_data/csse_covid_19_daily_reports"
nytimes_data_dir <- "covid-19-data"
owid_data_dir <- "owid-datasets/datasets"
ca_hospital_data <- "california-covid-19-hospital-data-and-case-statistics-pppjux"
```


```{r ca-hospital-data, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

ca_data <- read_csv(file.path(ca_hospital_data, "covid-19-cases.csv")) %>%
  mutate(`Most Recent Date` = as.Date(`Most Recent Date`, "%m/%d/%Y")) %>%
  rename("county" = `County Name`,
         "date" = `Most Recent Date`,
         "cases" = `Total Count Confirmed`,
         "deaths" = `Total Count Deaths`,
         "positive" = `COVID-19 Positive Patients`,
         "suspected" = `Suspected COVID-19 Positive Patients`,
         "icu_positive" = `ICU COVID-19 Positive Patients`,
         "icu_suspected" = `ICU COVID-19 Suspected Patients`)

ca_data %>%
  pivot_longer(cols=c(-county, -date), names_to = "desc", values_to = "count") %>%
  group_by(county, date) %>%
  summarize(count = sum(count))

ca_data %>%
  group_by(date) %>%
  summarize_if(is.numeric, sum, na.rm=TRUE) %>%
  pivot_longer(-date, names_to = "desc", values_to = "count") %>%
  arrange(desc(date)) %>%
  group_by(date) %>%
  summarize(count = sum(count)) %>%
  ggplot(aes(x=date, y=count)) +
  geom_point() +
  

```

```{r build_owid-data, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
## overkill: gets all of the owid data

owid_data_dirs <- dir_ls(owid_data_dir) #, glob="*.csv")
owid_covid_tests_file <- dir_ls(file.path(owid_data_dir, "COVID-19 Tests"), glob="*.csv")
owid_csv_data <- as_tibble(list(directory = dir_ls(owid_data_dir))) %>%
  mutate(filename = dir_ls(directory, glob="*.csv"),
         data = purrr::map(filename, read_csv))

owid_population_data <- owid_csv_data %>%
  filter(grepl("Population by country", filename), grepl("(Gapminder & UN)", filename)) %>%
  unnest() %>%
  dplyr::select(-directory, -filename)

owid_population_data %>%
  filter(Year==2019) %>%
  dplyr::select(1,4) %>%
  rename(pop = `Population by country, 1800 to 2015 (Gapminder & UN)`,
         country = Entity) %>%
  write_csv("demographic_data/owid_global_population_2019")
```

```{r demographic-data, echo=FALSE, warning=FALSE, message=FALSE}
global <- read_csv("demographic_data/owid_global_population_2019")

us_metro_pop <- read_csv("demographic_data/cbsa-est2019-alldata.csv") %>%
  select(CBSA, MDIV, STCOU, NAME, LSAD, POPESTIMATE2019) %>%
  rename(pop = POPESTIMATE2019)

us_county_pop <- read_csv("demographic_data/co-est2019-alldata.csv") %>%
  dplyr::select(1:7, 19) %>%
  rename(pop = POPESTIMATE2019) %>%
  mutate(county = gsub(" County", "", CTYNAME))

us_state_pop <- read_csv("demographic_data/nst-est2019-alldata.csv") %>%
  dplyr::select(1:5, 17) %>%
  rename(pop = POPESTIMATE2019)

## get state-level data
# us_county_pop %>%
#   filter(COUNTY == "000", STNAME == "Alabama")

## get county-level data
# us_county_pop %>%
#   filter(COUNTY != "000", STNAME == "Alabama")


```


```{r covidtracking-data-load, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

covid_tracking <- "https://covidtracking.com/api/"
covid_dataset_names <- c("states", "states/daily", "states/info",
                    "us", "us/daily",
                    "counties", "urls", "press")

covid_datasets <- lapply(as.list(paste0(covid_tracking, covid_dataset_names, ".csv")),
       function(api_call) {
         response <- GET(api_call)
         content(response)
       })

names(covid_datasets) <- covid_dataset_names

covid_datasets$states_qc <- covid_datasets$states %>%
  select(state, lastUpdateEt, checkTimeEt, dateModified, dateChecked, grade)

covid_datasets$states <- covid_datasets$states %>%
  select(-lastUpdateEt, -checkTimeEt, -dateModified, -dateChecked, -grade)

covid_datasets$`states/daily` <- covid_datasets$`states/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d")) %>%
  select(-dateChecked)

covid_datasets$`us/daily` <- covid_datasets$`us/daily` %>%
  mutate(date = as.Date(as.character(date), "%Y%m%d"))

```



```{r map-data-setup, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
states_map <- map_data("state")
counties_map <- map_data("county")

state_abbreviations <- c("AL", "AK", "AZ", "KS", "UT", "CO", "CT", 
                         "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "AR", 
                         "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", 
                         "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", 
                         "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", 
                         "CA", "VT", "VA", "WA", "WV", "WI", "WY", "DC")
state_names <- c("Alabama", "Alaska", "Arizona", "Kansas", 
                "Utah", "Colorado", "Connecticut", "Delaware", "Florida", 
                "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", 
                "Iowa", "Arkansas", "Kentucky", "Louisiana", "Maine", 
                "Maryland", "Massachusetts", "Michigan", "Minnesota", 
                "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", 
                "New Hampshire", "New Jersey", "New Mexico", "New York", 
                "North Carolina", "North Dakota", "Ohio", 
                "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", 
                "South Carolina", "South Dakota", "Tennessee", "Texas", 
                "California", "Vermont", "Virginia", "Washington", "West Virginia", 
                "Wisconsin", "Wyoming", "District of Columbia")
names(state_names) <- state_abbreviations
names(state_abbreviations) <- state_names
```

```{r nytimes-load, echo=FALSE, warning=FALSE, message=FALSE}
nyt_counties <- read_csv(paste0(nytimes_data_dir, "/us-counties.csv"))
nyt_states <- read_csv(paste0(nytimes_data_dir, "/us-states.csv"))

## From NY Times web page, scraped 2020-05-03
shutdown_dates <- read_csv("statewide_events.csv") %>%
  pivot_longer(-state, names_to = "event", values_to = "event_date") %>%
  mutate(event_date = as.Date(paste0("2020-", event_date)),
         state = state_names[state]) %>%
  arrange(state, event_date)
```


```{r csse-new-data-model-load, echo=FALSE, warning=FALSE, message=FALSE}

# daily reports data. follows different data models at different times, so a fair bit
#  of tweeking is necessary

data_model_start_dates <- as.Date(c("01-22-2020", "03-22-2020"), "%m-%d-%Y")

data_models <- Vectorize(function(obs_date, start_dates) {
  end_dates <- lead(c(start_dates,today() + days(1))-days(1))[1:length(start_dates)]
  intervals <- lubridate::interval(start = start_dates, end = end_dates)
  which(obs_date %within% intervals)
}, "obs_date")

report_files <- dir_ls(csse_data_dir, glob="*.csv")
report_dates <- as.Date(path_ext_remove(path_file(report_files)), "%m-%d-%Y")
report_models <- data_models(report_dates, data_model_start_dates)
report_sets <- as_tibble(list(file = report_files,
                              date = path_ext_remove(path_file(report_files)),
                              model = report_models))

data_columns <- cols(
  `Province/State` = col_character(),
  `Country/Region` = col_character(),
  Province_State = col_character(),
  Country_Region = col_character(),
  `Last Update` = col_skip(),
  Last_Update = col_skip(),
  Confirmed = col_double(),
  Deaths = col_double(),
  Recovered = col_double(),
  Latitude = col_double(),
  Longitude = col_double(),
  Lat = col_double(),
  Long_ = col_double(),
  FIPS = col_character(),
  Admin2 = col_character()
)

report_data <- do.call(rbind.data.frame, report_sets %>%
  split(.$model) %>%
  purrr::map(~ .x %>%
              select(date, file) %>%
              deframe() %>%
               map_dfr(read_csv, .id="date",
                       col_types=data_columns) %>%
               add_column(!!!c("FIPS","Admin2")[!c("FIPS","Admin2") %in% names(.)]) %>%
               rename_at(vars(matches("\\/")), function(x) gsub("\\/","_",x)) %>%
               rename_at(vars(matches("_$")), function(x) gsub("_$","",x)) %>%
               rename_at(vars(matches("itude$")), function(x) gsub("itude$","",x)) %>%
               rename_at(vars(matches("FIPS")), function(x) "FIPS") %>%
               rename_at(vars(matches("Admin2")), function(x) "Admin2") %>%
               mutate(date = as.Date(date, "%m-%d-%Y"),
                      FIPS = ifelse(FIPS=="FIPS", NA, FIPS),
                      Admin2 = ifelse(Admin2=="Admin2", NA, Admin2)) %>%
               select(date, FIPS, Admin2, Province_State, Country_Region,
                      Confirmed, Deaths, Recovered)
  ))

## recoding country name errors
countries <- report_data %>%
  rename("country" = Country_Region) %>%
  mutate("name" = country) %>%
  mutate(country = ifelse(grepl("Bahamas", country), "Bahamas", country),
         country = ifelse(grepl("China", country), "China", country),
         country = ifelse(grepl("Congo", country), "Congo", country),
         country = ifelse(grepl("Czech", country), "Czechia", country),
         country = ifelse(grepl("Gambia", country), "Gambia", country),
         country = ifelse(grepl("Guinea", country), "Guinea", country),
         country = ifelse(grepl("Hong Kong", country), "Hong Kong", country),
         country = ifelse(grepl("Iran", country), "Iran", country),
         country = ifelse(grepl("Ireland$", country), "Ireland", country),
         country = ifelse(grepl("Maca", country), "Macau", country),
         country = ifelse(grepl("Martin$", country), "Saint Martin", country),
         country = ifelse(grepl("Moldova$", country), "Moldova", country),
         country = ifelse(grepl("Palestin", country), "Palestine", country),
         country = ifelse(grepl("Russia", country), "Russia", country),
         country = ifelse(grepl("Timor", country), "Timor", country),
         country = ifelse(grepl("Viet", country), "Vietnam", country),
         country = ifelse(grepl("Taiwan", country) | grepl("Taipei", country),
                          "Taiwan", country),
         country = ifelse(country=="United Kingdom", "UK", country),
         country = ifelse(country=="Korea, South", "South Korea", country),
         country = ifelse(country=="Republic of Korea", "North Korea", country),
         country = ifelse(country=="Holy See" | grepl("Vatican", country),
                          "Vatican City", country),
         country = ifelse(country=="Jersey" | country=="Guernsey", "Channel Islands", country),
         country = ifelse(country=="Cote d'Ivoire", "Ivory Coast", country)) %>%
  select(name, country) %>%
  distinct() %>%
  filter(!is.na(country)) %>%
  arrange(country) %>%
  deframe()

## recoding state name errors
states <- report_data %>%
  rename("country" = Country_Region, "state" = Province_State) %>%
  mutate("name" = state) %>%
  mutate(state = ifelse(country=="US" & grepl("Virgin Islands", state),
                        "Virgin Islands", state),
         state = ifelse(country=="US" & grepl("D.C.", state),
                        "District of Columbia", state),
         state = ifelse(country=="US" & grepl("New York", state),
                        "New York", state)) %>%
  select(name, state) %>%
  distinct() %>%
  filter(!is.na(state)) %>%
  arrange(state) %>%
  deframe()

complete <- report_data %>%
  rename("country"=Country_Region,
         "state"=Province_State,
         "county"=Admin2,
         "cases"=Confirmed,
         "deaths"=Deaths,
         "recovered"=Recovered) %>%
  mutate(country = recode(country, !!!countries)) %>%
  mutate(state = recode(state, !!!states)) %>%
  filter(!grepl("Travis, CA", state))

```


```{r load-new-data-model, echo=FALSE, warning=FALSE, message=FALSE}

# build data structures for specific uses


# US states
# limit to US and remove locations (mostly through early March) that are specific within states
#   (e.g., "Berkeley, CA")
by_state <- complete %>%
  filter(country=="US") %>%
  ungroup() %>%
  separate(state, into=c("region", "st"), sep=",", fill="left", remove=FALSE) %>%
  mutate(st=state_names[str_trim(st)],
         region=str_trim(region),
         state=if_else(is.na(st), state, st)) %>%
  select(-st) %>%
  group_by(state, date) %>%
  summarize(cases=sum(cases), recovered=sum(recovered), deaths=sum(deaths))
 
# totals by country
by_country <- complete %>%
  group_by(country, date) %>%
  summarize(cases=sum(cases), recovered=sum(recovered), deaths=sum(deaths))

# total by country, except US where total by state
# (for comparing US states to countries ex-US)
by_country_state <- by_state %>%
  rename(country = state) %>%
  bind_rows(by_country) %>%
  distinct()

us_states <- by_state %>%
  left_join(us_county_pop %>% filter(COUNTY == "000"), by = c("state" = "STNAME")) %>%
  dplyr::select(state, pop, date, cases, recovered, deaths)

us_states_current <- us_states %>%
  group_by(state, date) %>%
  summarize_if(is.numeric, sum) %>%
  arrange(state, date) %>%
  slice(n())

us_counties_current <- complete %>%
  filter(country=="US", !is.na(county)) %>%
  group_by(state, county) %>%
  top_n(1, date) %>%
  left_join(us_county_pop %>% filter(COUNTY != "000"),
            by = c("state" = "STNAME", "county" = "county")) %>%
  filter(!is.na(pop)) %>%
  dplyr::select(state, pop, date, cases, recovered, deaths)

latest_date <- complete %>%
  filter(cases > 0 | recovered == 0 | deaths == 0) %>%
  select(date) %>%
  top_n(1, date) %>%
  distinct() %>%
  dplyr::pull(date)

latest_date <- as.Date(latest_date)
```

# Progression of cases compared between countries

```{r plot-all-countries, fig.wide = TRUE, fig.cap = "Progression of cases between countries. Day 0 for each country is the first day for which there is data. In some cases (e.g., China, Japan) the pandemic was well underway before data were recorded by JHU.", echo=FALSE, warning=FALSE, message=FALSE}

by_country %>%
  filter(cases >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases, group=country)) +
    geom_line(aes(color=country)) +
    geom_text(data = subset(., day == maxday & maxday > 10), aes(label = country,
                                                     colour = country,
                                                     x = day,
                                                     y = cases), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme_minimal() +  
    theme(legend.position = "none") +
    xlim(0, max(.$day) + 10) +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }
```

```{r country-case-facetplot, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
# facetplot of countries
by_country %>%
  filter(cases >= 100) %>%
  group_by(country) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases)) +
    geom_line() +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme(legend.position = "none") +
    facet_wrap( ~ country, ncol = 3) +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }


```

# Comparison of US to selected other countries

```{r us-italy-china-spain-plot, fig.wide = TRUE, fig.cap = "Pandemic trajectories of several countries. Day of pandemic is an adjustment to allow for different local pandemic start dates.", echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("China", "Italy", "Spain", "US")
p1 <- country_timeplot(countries, quo(cases))
p2 <- country_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)

```


```{r us-italy-china-spain-daily, fig.wide = TRUE, fig.cap = "Daily new cases and deaths for selected countries.", echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("China", "Italy", "Spain", "US")
p1 <- country_daily_timeplot(countries, quo(cases))
p2 <- country_daily_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)

```

```{r us-italy-plot, eval = FALSE, fig.wide = TRUE, fig.cap = "Comparing US to Italy. Day of pandemic is an adjustment to allow for different local pandemic start dates.", echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("Italy", "US")
p1 <- country_timeplot(countries, quo(cases))
p2 <- country_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)

p1 <- country_daily_timeplot(countries, quo(cases))
p2 <- country_daily_timeplot(countries, quo(deaths))
grid.arrange(p1, p2, nrow = 1)

```

# Confirmed cases and deaths by US state

## Timeline for all US States

```{r plot-all-states, fig.wide = TRUE, fig.cap = "Progression of cases between states. Day 0 for each state is the first day where the number of cases reached 100.", echo=FALSE, warning=FALSE, message=FALSE}

us_states %>%
  filter(cases >= 100) %>%
  group_by(state) %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases, group=state)) +
    geom_line(aes(color=state)) +
    geom_text(data = subset(., day == maxday), aes(label = state,
                                                     colour = state,
                                                     x = day,
                                                     y = cases), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed cases") +
    scale_y_log10() +
    theme_minimal() +  
    theme(legend.position = "none") +
    xlim(0, max(.$day) + 10) +
    ggtitle(paste("Confirmed cases as of", latest_date))
  }
```

## Daily totals by state

```{r plot-daily-all-states, fig.wide = TRUE, fig.cap = "Progression of new cases between states.", echo=FALSE, warning=FALSE, message=FALSE}

us_states %>%
  filter(cases >= 100) %>%
  group_by(state) %>%
  daily_from_cumulative() %>%
  mutate(day = date - min(date), maxday = max(day)) %>%
  {
    ggplot(., aes(x=day, y=cases, group=state)) +
    geom_line(aes(color=state)) +
    geom_text(data = subset(., day == maxday), aes(label = state,
                                                     colour = state,
                                                     x = day,
                                                     y = cases), hjust = -.1) +
    xlab("Day of pandemic") +
    ylab("Confirmed new cases") +
 #   scale_y_log10() +
    theme_minimal() +  
    theme(legend.position = "none") +
    xlim(0, max(.$day) + 10) +
    ggtitle(paste("Daily confirmed new cases as of", latest_date))
  }
```

## Current cumulative cases and deaths by state



```{r state-plots, fig.wide = TRUE, fig.cap = "Cases and deaths by state. Barplots show 10 most affected states", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- us_states_current %>% state_map(quo(cases))
p2 <- us_states_current %>% state_map(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

p1 <- us_states_current %>% states_current_barplot(quo(cases))
p2 <- us_states_current %>% states_current_barplot(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

```

## Current cumulative per capita cases and deaths by state

```{r per-capita-state-plots, fig.wide = TRUE, fig.cap = "Cases and deaths per million population by state. Barplots show 10 most affected states", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- us_states_current %>%
  mutate_at(c("cases", "deaths", "recovered"), ~ (. * 1e6) / pop) %>%
  state_map(quo(cases))
p2 <- us_states_current %>%
  mutate_at(c("cases", "deaths", "recovered"), ~ (. * 1e6) / pop) %>%
  state_map(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

p1 <- us_states_current %>%
  mutate_at(c("cases", "deaths", "recovered"), ~ (. * 1e6) / pop) %>%
  states_current_barplot(quo(cases))
p2 <- us_states_current %>%
  mutate_at(c("cases", "deaths", "recovered"), ~ (. * 1e6) / pop) %>%
  states_current_barplot(quo(deaths))

grid.arrange(p1, p2, nrow = 1)

```

# Progression within a US state

## Timeline of confirmed cases and deaths for California counties

```{r ca-county-timeplot, fig.wide = TRUE, fig.cap = "Cases and deaths within California.", echo=FALSE, warning=FALSE, message=FALSE}

p5 <- complete %>%
  filter(country=="US", state=="California") %>%
  county_timeplot(quo(cases))
p6 <- complete %>%
  filter(country=="US", state=="California") %>%
  county_timeplot(quo(deaths))
grid.arrange(p5, p6, nrow = 1)

```

## Current cumulative cases and deaths by California county

```{r ca-county-plot, fig.wide = TRUE, fig.cap = "Cases and deaths within California.", echo=FALSE, warning=FALSE, message=FALSE}
p1 <- us_counties_current %>%
  filter(state=="California") %>%
  county_map(quo(cases))
p2 <- us_counties_current %>%
  filter(state=="California") %>%
  county_map(quo(deaths))
grid.arrange(p1, p2, nrow = 1)

p3 <- us_counties_current %>%
  filter(state=="California") %>%
  county_barplot(quo(cases))
p4 <- us_counties_current %>%
  filter(state=="California") %>%
  county_barplot(quo(deaths))
grid.arrange(p3, p4, nrow = 1)



```

## Current cumulative per capita cases and deaths by California county

```{r per-capita-ca-county-plot, fig.wide = TRUE, fig.cap = "Cases and deaths per million within California.", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- us_counties_current %>%
  filter(state=="California") %>%
#  mutate_at(c("cases", "deaths", "recovered"), ~ . / pop) %>%
  mutate(cases = 1e6 * cases / pop, se = 1e6 * sqrt(cases / pop)) %>%
  county_map(quo(cases))
p2 <- us_counties_current %>%
  filter(state=="California") %>%
  mutate(deaths = 1e6 * deaths / pop, se = 1e6 * sqrt(deaths / pop)) %>%
  county_map(quo(deaths))
grid.arrange(p1, p2, nrow = 1)

p3 <- us_counties_current %>%
  filter(state=="California") %>%
  mutate(cases = 1e6 * cases / pop, se = 1e6 * sqrt(cases / pop)) %>%
  county_barplot(quo(cases))
p4 <- us_counties_current %>%
  filter(state=="California") %>%
  mutate(deaths = 1e6 * deaths / pop, se = 1e6 * sqrt(deaths / pop)) %>%
  county_barplot(quo(deaths))
grid.arrange(p3, p4, nrow = 1)
```


# Progression within the nine counties of the SF Bay Area

## Timeline of confirmed cases and deaths for Bay Area counties

```{r ba-county-timeplot, fig.wide = TRUE, fig.cap = "Cases and deaths within SF Bay Area counties", echo=FALSE, warning=FALSE, message=FALSE}

bay_area <- c("Santa Clara", "Alameda", "San Francisco", "San Mateo",
                       "Contra Costa", "Marin", "Sonoma", "Solano", "Napa")

p5 <- complete %>%
  filter(country=="US", state=="California", county %in% bay_area) %>%
  county_timeplot(quo(cases))
p6 <- complete %>%
  filter(country=="US", state=="California", county %in% bay_area) %>%
  county_timeplot(quo(deaths))
grid.arrange(p5, p6, nrow = 1)

```

## Current cumulative cases and deaths for Bay Area counties


```{r ba-county-plot, fig.wide = TRUE, fig.cap = "Cases and deaths within SF Bay Area counties", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  county_map(quo(cases), show_state=FALSE)
p2 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  county_map(quo(deaths), show_state=FALSE)
grid.arrange(p1, p2, nrow = 1)

p3 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  county_barplot(quo(cases))
p4 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  county_barplot(quo(deaths))
grid.arrange(p3, p4, nrow = 1)



```

## Current cumulative per capita cases and deaths for Bay Area counties

```{r per-capita-ba-county-plot, fig.wide = TRUE, fig.cap = "Cases and deaths per million within SF Bay Area counties", echo=FALSE, warning=FALSE, message=FALSE}

p1 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
#  mutate_at(c("cases", "deaths", "recovered"), ~ . / pop) %>%
  mutate(cases = 1e6 * cases / pop, se = 1e6 * sqrt(cases / pop)) %>%
  county_map(quo(cases), show_state=FALSE)
p2 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  mutate(deaths = 1e6 * deaths / pop, se = 1e6 * sqrt(deaths / pop)) %>%
  county_map(quo(deaths), show_state=FALSE)
grid.arrange(p1, p2, nrow = 1)

p3 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  mutate(cases = 1e6 * cases / pop, se = 1e6 * sqrt(cases / pop)) %>%
  county_barplot(quo(cases))
p4 <- us_counties_current %>%
  filter(state=="California", county %in% bay_area) %>%
  mutate(deaths = 1e6 * deaths / pop, se = 1e6 * sqrt(deaths / pop)) %>%
  county_barplot(quo(deaths))
grid.arrange(p3, p4, nrow = 1)
```


# Comparison of selected countries and US states

```{r country-state-plot, echo=FALSE, warning=FALSE, message=FALSE}
countries <- c("Italy", "California", "New York", "Washington")

country_state_plot(countries, quo(cases))
country_state_plot(countries, quo(deaths))
```

# Number of tests administered (from `covidtracking.com`)

```{r state-testing-rates, echo=FALSE, warning=FALSE, message=FALSE}
states <- c("California", "New York", "Washington")

covid_datasets$`states/daily` %>%
  filter(state %in% state_abbreviations[states]) %>%
  ggplot(aes(x=date, y=total, color=state)) +
  geom_line() +
  geom_bar(aes(y=positive, fill=state), stat = "identity", position = 'dodge') +
  xlab("Date") +
  ylab("Test counts") +
  ggtitle("Number of tests administered and number positive")

covid_datasets$`states/daily` %>%
  filter(state %in% state_abbreviations[states]) %>%
  mutate(positive_fraction = positive/posNeg) %>% 
  ggplot(aes(x=date, y=positive_fraction, color=state)) +
  geom_line() +
  xlab("Date") +
  ylab("Fraction of tests positive") +
  ggtitle("Positive test results")
```

```{r covidtracking-maps, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
states_map %>%
  left_join(
    covid_datasets$`states/daily` %>%
      group_by(state) 
    mutate(state = state_names[state],
           region = tolower(state)) %>%
      filter(!is.na(region))) %>%
    select(state, date, lat, long, positive, negative, pending, hospitalized, death, total) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = cases), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Confirmed cases as of", latest_date))

states_map %>%
  left_join(
    us_states_current %>%
    mutate(fips = state_abbreviations[state],
          region = tolower(state)) %>%
    filter(!is.na(region)) %>%
    select(region, deaths)
  ) %>%
  ggplot(aes(long, lat, group = group)) +
  geom_polygon(aes(fill = deaths), color = "white") +
  scale_fill_viridis_c(option = "C") +
  coord_fixed(1.3) +
  ggtitle(paste("Statewide deaths as of", latest_date))

```


# Estimating maximum rate of exponential growth in number of observed cases

Exponential growth parameters were estimated for 5-day moving window over cases.

```{r curve-fits, echo=FALSE, warning=FALSE, message=FALSE}

countries <- c("China","New York","Italy","Spain",
               "California","Washington", "US", "South Dakota")

exp_fits <- by_country_state %>%
  filter(country %in% countries, cases > 100) %>%
  exp_fit(quo(country), quo(cases), window = 5) %>%
  group_by(country) %>%
  mutate(max_est = purrr::map_dbl(data, ~max(.$estimate)),
         max_date = as.Date(purrr::map_dbl(data, ~ .$date[which.max(.$estimate)]),
                            origin = "1970-01-01"),
         last_est = purrr::map_dbl(data, ~ .$estimate[which.max(.$date)]),
         last_date = as.Date(purrr::map_dbl(data, ~ max(.$date)),
                            origin = "1970-01-01"))


p1 <- exp_fits %>%
  unnest(data) %>%
  { ggplot(., aes(x = date, y = estimate, color = country)) +
      geom_line() +
      geom_text(data = . %>%
                  filter(date == max_date) %>%
                  ungroup(),# %>%
                  #top_n(topn, estimate),
                aes(label = country, color = country, x = date, y = estimate),
                hjust = "right",
                vjust = "bottom") +
      theme_minimal() +
      theme(legend.position = "none") +
      ggtitle("Exponential parameter over previous 5 days")
  }

p2 <- by_country_state %>%
  filter(country %in% countries) %>%
  mutate(cases = log(cases + 1)) %>%
  ggplot(aes(x=date, y=cases, color=country)) +
  geom_line(aes(y=cases, color=country)) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p1, p2, nrow = 2)

```


```{r exp-fit-table, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
exp_fits %>%
  select(-data) %>%
  arrange(desc(max_est)) %>%
  rename("Maximum rate" = max_est, "Date of maximum" = max_date,
         "Current rate" = last_est, "Current date" = last_date) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```



```{r state-curve-fits, echo=FALSE, warning=FALSE, message=FALSE}

states = c("California", "New York", "South Dakota")

exp_fits <- us_states %>%
  filter(cases > 9) %>%
  exp_fit(quo(state), quo(cases), window = 5) %>%
  group_by(state) %>%
  mutate(max_est = purrr::map_dbl(data, ~max(.$estimate)),
         max_date = as.Date(purrr::map_dbl(data, ~ .$date[which.max(.$estimate)]),
                            origin = "1970-01-01"),
         last_est = purrr::map_dbl(data, ~ .$estimate[which.max(.$date)]),
         last_date = as.Date(purrr::map_dbl(data, ~ max(.$date)),
                            origin = "1970-01-01"))


p1 <- exp_fits %>%
  filter(state %in% states) %>%
  unnest(data) %>%
  { ggplot(., aes(x = date, y = estimate, color = state)) +
      geom_line() +
      geom_text(data = . %>%
                  filter(date == max_date) %>%
                  ungroup(),# %>%
                  #top_n(topn, estimate),
                aes(label = state, color = state, x = date, y = estimate),
                hjust = "right",
                vjust = "bottom") +
      theme_minimal() +
      theme(legend.position = "none") +
      ggtitle("Exponential parameter over previous 5 days")
  }

p2 <- us_states %>%
  filter(state %in% states, cases > 9) %>%
  mutate(cases = log(cases + 1)) %>%
  ggplot(aes(x=date, y=cases, color=state)) +
  geom_line(aes(y=cases, color=state)) +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(p1, p2, nrow = 2)

```

## State exponential fits, 10 highest maximum rates of growth

```{r state-max-exp-fit-table, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
exp_fits %>%
  select(-data) %>%
  ungroup() %>%
  arrange(desc(max_est)) %>%
  slice(1:10) %>%
  rename("Maximum rate" = max_est, "Date of maximum" = max_date,
         "Current rate" = last_est, "Current date" = last_date) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


## State exponential fits, 10 highest current rates of growth

```{r state-last-exp-fit-table, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}
exp_fits %>%
  select(-data) %>%
  ungroup() %>%
  arrange(desc(last_est)) %>%
  slice(1:10) %>%
  rename("Maximum rate" = max_est, "Date of maximum" = max_date,
         "Current rate" = last_est, "Current date" = last_date) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```


```{r curve-fit-plot-functions, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}

countries <- bounds %>%
  unnest(bounds) %>%
  ungroup() %>%
  select(country) %>%
  distinct() %>%
  dplyr::pull(country)

p1 <- country_log_timeplot(by_country_state, countries, quo(deaths), topn=10)


lag_day <- lag_days(by_country_state, countries) %>% select(country, cases) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - lag_day[country], "log_confirmed" = log(cases + 1)) %>%
  ggplot(aes(x=date, y=log_confirmed), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("Log(confirmed cases)") +
  ggtitle(paste("Confirmed cases as of", latest_date))

exp_phase_fit_cases %>%
  augment(fit) %>%
  rename("log_confirmed" = `log.cases...1.`) %>%
  ggplot(aes(x=day, y=log_confirmed), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log10(confirmed cases)") +
  ggtitle(paste("Exponential phase of growth in confirmed cases as of", latest_date))

lag_day <- lag_days(by_country_state, countries) %>% select(country, deaths) %>% deframe()

by_country_state %>%
  filter(country %in% countries) %>%
  mutate("day" = date - lag_day[country], "log_deaths" = log(deaths + 1)) %>%
  ggplot(aes(x=date, y=log_deaths), color=country) +
  geom_line(aes(color=country)) +
  xlab("Date") +
  ylab("log(deaths)") +
  ggtitle(paste("Deaths as of", latest_date))

exp_phase_fit_deaths %>%
  augment(fit) %>%
  rename("log_deaths" = `log.deaths...1.`) %>%
  ggplot(aes(x=day, y=log_deaths), color=country) +
  geom_point(aes(color=country)) +
  geom_line(aes(y=.fitted, color=country)) +
  xlab("Day of exponential phase") +
  ylab("log(deaths)") +
  ggtitle(paste("Exponential phase of growth in deaths as of", latest_date))

```

```{r exp-fit-tables, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE, results="asis"}

exp_phase_tabular <- exp_phase_fit %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in confirmed cases")

exp_phase_deaths_tabular <- exp_phase_fit_deaths %>%
  tidy(fit) %>%
  filter(term=="day") %>%
  mutate("start"=exp_start[country], "end"=exp_end[country]) %>%
  rename("region"=country)

exp_phase_deaths_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

exp_phase_deaths_tabular %>%
  arrange(desc(estimate)) %>%
  ungroup() %>%
  ggplot(aes(x=reorder(region, desc(estimate)), y=estimate)) +
  geom_bar(stat="identity", width=0.5, fill="steelblue") +
  geom_errorbar(aes(x=region, ymin=estimate - std.error, ymax=estimate + std.error),
                width=0.2) +
  theme_minimal() +
  xlab("Region") +
  ylab("Exponential parameter") +
  ggtitle("Maximum rate of exponential growth (+/- SE) in deaths")
```


# Average daily statistics, by selected US state

```{r state-daily, echo=FALSE, warning=FALSE, message=FALSE}

state_daily_stats <- us_states %>%
  daily_from_cumulative()

state_peak_stats <- state_daily_stats %>%
  pivot_longer(c(-state, -date), names_to="obs", values_to="value") %>%
  group_by(state, obs) %>%
  arrange(state, obs, desc(value)) %>%
  top_n(1, value) %>%
  arrange(state, obs, desc(date)) %>%
  filter(grepl("new_", obs)) %>%
  slice(1)

event_dates <- exp_fits %>%
  dplyr::select(-data, -max_est, -last_est, -last_date) %>%
  rename("max_exp" = max_date) %>%
  pivot_longer(-state, names_to = "event", values_to = "event_date") %>%
  bind_rows(shutdown_dates) %>%
  arrange(state, event_date)

split_chunks <- function(tbl, chunksize = 4) {
  n <- nrow(tbl)
  r <- rep(1:ceiling(n/chunksize),each=chunksize)[1:n]
  lapply(split(tbl,r), function(chunk) chunk %>% dplyr::pull(state))
}

sip_classes <- event_dates %>%
  pivot_wider(names_from=event, values_from=event_date) %>%
  dplyr::select(state, sip_start, sip_end) %>%
  mutate(class = case_when(!is.na(sip_start) & !is.na(sip_end) & sip_end < today() ~ "on_off",
                           !is.na(sip_start) ~ "on",
                           TRUE ~ "off")) %>%
  group_by(class) %>%
  filter(state %in% state_names)

states_by_sip_policy <- sip_classes %>%
  group_map(~ split_chunks(.x))
names(states_by_sip_policy) <- c("off", "on", "on_off")

```

## Average daily new cases

```{r average-daily-new-cases, fig.cap = "Daily new cases with 5-day rolling mean. Red dotted line indicates the start date for statewide shelter-in-place restrictions. Green indicates the lifting of SIP.", echo=FALSE, warning=FALSE, message=FALSE}

new_cases_plots <- lapply(states_by_sip_policy,
                          function(class)
                            lapply(class, function(states) {
                              state_daily_stats %>%
                                filter(state %in% states) %>%
                                rolling_average(variable = quo(new_cases))
                            })
)
new_cases_plots

# states <- c("Mississippi", "Florida", "Michigan", "Arizona")
# state_daily_stats %>%
#   filter(state %in% states) %>%
#   rolling_average(variable = quo(new_cases))
# 
# states <- c("Washington","California","New York", "Louisiana")
# state_daily_stats %>%
#   filter(state %in% states) %>%
#   rolling_average(variable = quo(new_cases))
# 
# states <- c("Alabama", "Georgia", "Kentucky", "Virginia")
# state_daily_stats %>%
#   filter(state %in% states) %>%
#   rolling_average(variable = quo(new_cases))
# 
# states <- c("Maryland", "District of Columbia", "West Virginia", "Virginia")
# state_daily_stats %>%
#   filter(state %in% states) %>%
#   rolling_average(variable = quo(new_deaths))

```

## Average daily new deaths

```{r average-daily-new-deaths, fig.cap = "Daily new deaths with 5-day rolling mean. Red dotted line indicates the start date for statewide shelter-in-place restrictions. Green indicates the lifting of SIP.", echo=FALSE, warning=FALSE, message=FALSE}
states <- c("Mississippi", "Florida", "Michigan", "Arizona")
state_daily_stats %>%
  filter(state %in% states) %>%
  rolling_average(variable = quo(new_deaths))

states <- c("Washington","California","New York", "Louisiana")
state_daily_stats %>%
  filter(state %in% states) %>%
  rolling_average(variable = quo(new_deaths))

states <- c("Alabama", "Georgia", "Kentucky", "Virginia")
state_daily_stats %>%
  filter(state %in% states) %>%
  rolling_average(variable = quo(new_deaths))
```


# Maximum daily new cases and deaths by US state

## New cases and deaths

```{r max-new-daily, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
us_states %>%
  daily_from_cumulative() %>%
  ungroup() %>%
  select(-pop) %>%
  pivot_longer(c(-state, -date), names_to="obs", values_to="value") %>%
  arrange(state, date, obs) %>%
  group_by(state, obs) %>%
  top_n(-1)
  
  
exp_phase_tabular %>%
  select(region, start, end, estimate) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## New cases and deaths per million population

# References and other resources

## Primary data sources

* [JHU dashboard](https://coronavirus.jhu.edu/map.html)
* [The COVID Tracking Project](https://covidtracking.com/)
* NY Times tracking data
* CA hostpital data

## Other sources

* [UW Virology COVID-19 Dashboard](http://depts.washington.edu/labmed/covid19/)
* [Kinsa US Health Weather Map](https://healthweather.us/): real-time tracking of atypical fever frequencies
* [Epidemic modeling](http://gabgoh.github.io/COVID/index.html)
* [NEJM Coronavirus papers](https://www.nejm.org/coronavirus?cid=DM88311&bid=165352681)
* [Our World in Data](https://ourworldindata.org/coronavirus)
* [JHU news releases](https://releases.jhu.edu/)
* [SF Chronicle California case tracker](https://projects.sfchronicle.com/2020/coronavirus-map/)
* [Real-time tracking of pathogen evolution](https://nextstrain.org/)
* [91-divoc](https://91-divoc.com)
* [COVID-19 health data](https://covid19.healthdata.org/)
* [Covid Counties](https://covidcounties.org/)
* [San Francisco Open Data cases by zip code](https://data.sfgov.org/stories/s/Map-of-Cases-by-Zip-Code/bj8f-r6sy/)

## News links

* [The Atlantic Covid-19 coverage](https://www.theatlantic.com/category/what-you-need-know-coronavirus/)
* [Home testing](https://www.ninetylawn.com/at-home-coronavirus-testing/)

## Updates and notes

JHU appears to update their data daily at around 4pm PDT. I usually re-run the script sometime after that. At other times I'm fiddling with changing layouts and refactoring code, and updates usually reflect that.

Currently, plots are aligned by setting the local day 0 as the date at which a given country/locality crosses 10% of the maximum cases, deaths, etc. in a comparison.

To do: automate the estimation of maximum exponential parameter for various curves. Currently this is done by manually setting a date range over which the fit is done.

I'll be happy to take requests for specific plots. Feel free to open an issue on the [project GitHub page](https://github.com/MattBrauer/covid19). Also, take, use and propagate any code or data you find there if you find it useful.
